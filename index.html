<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>🏰 勇者の冒険 ⚔️</title>
  <style>
    /* ===== 基本設定（iPhone操作性優先） ===== */
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;}
    body{
      font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP","MS PGothic",system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,#667eea,#764ba2);
      color:#2d3436;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }
    :root{
      --primary:#667eea;
      --secondary:#6c5ce7;
      --accent:#00cec9;
      --danger:#e17055;
      --panel:#ffffff;
    }
    #game{
      position:relative;
      width:100vw;height:100vh;max-width:920px;max-height:640px;
      margin:0 auto;background:#fff;border:4px solid #2d3436;border-radius:16px;
      overflow:hidden; box-shadow:0 18px 40px rgba(0,0,0,.35);
      padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
    }
    .screen{
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:#fff; padding:20px; text-align:center;
    }
    .hidden{display:none!important;}
    h1{font-size:clamp(24px,4.2vw,36px); margin-bottom:16px;}
    h2{font-size:clamp(20px,3.6vw,28px); margin-bottom:12px;}
    p{font-size:clamp(14px,2.8vw,18px); line-height:1.6;}
    .btn{
      background:linear-gradient(45deg,var(--primary),var(--secondary));
      color:#fff; border:none; border-radius:14px;
      padding:14px 18px; font-size:clamp(16px,3.8vw,20px); font-weight:700;
      width:min(84%,360px); margin:8px auto; box-shadow:0 6px 14px rgba(0,0,0,.25);
      cursor:pointer;
    }
    .btn:active{transform:scale(.97);}
    .btn.outline{
      background:#fff;color:var(--primary);
      border:2px solid var(--primary);
    }

    /* ===== ステータスバー ===== */
    #hud{
      position:absolute; left:0; right:0; top:0;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 14px calc(10px + env(safe-area-inset-top));
      background:linear-gradient(90deg,#74b9ff,#0984e3);
      color:#fff; z-index:20;
      border-bottom:3px solid rgba(0,0,0,.15);
    }
    .hud-group{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .tag{background:rgba(255,255,255,.2); padding:6px 10px; border-radius:10px; font-weight:700;}
    .bar{width:120px; height:10px; background:rgba(255,255,255,.35); border-radius:6px; overflow:hidden; border:1px solid rgba(255,255,255,.6);}
    .bar>i{display:block; height:100%; width:100%; background:linear-gradient(90deg,#e17055,#ff7675);}
    .bar.mp>i{background:linear-gradient(90deg,#a29bfe,#6c5ce7);}

    /* ===== メッセージ帯 ===== */
    #msg{
      position:absolute; left:12px; right:12px; bottom:12px;
      background:rgba(255,255,255,.95); border:2px solid #e9e9e9; border-radius:12px;
      min-height:58px; display:flex; align-items:center; justify-content:center;
      padding:10px 12px; z-index:12; box-shadow:inset 0 2px 6px rgba(0,0,0,.08);
      font-weight:700;
    }

    /* ===== フィールド（タイルマップ） ===== */
    #field{
      position:absolute; inset:0; display:flex; flex-direction:column; gap:8px;
      padding:72px 12px 96px; /* 余白: HUDとメッセージ帯を避ける */
      background:linear-gradient(135deg,#55efc4,#81ecec);
    }
    #grid{
      flex:1; display:grid; place-content:center;
      grid-template-columns:repeat(var(--cols), minmax(0,1fr));
      gap:4px; max-width:min(92vw,840px); margin:0 auto; width:100%;
    }
    .tile{
      aspect-ratio:1/1; border-radius:8px; display:grid; place-items:center;
      font-size:clamp(18px,3.4vw,26px); background:#cdeccd; border:1px solid rgba(0,0,0,.05);
      user-select:none;
    }
    .plains{background:#cdeccd;}
    .forest{background:#b7e4b7;}
    .mountain{background:#e0d9c9;}
    .desert{background:#f9e6b3;}
    .water{background:#b9e7ff;}
    .town{background:#ffeab6; border-color:#ffcc66;}
    .cave{background:#e8dff6;}
    .castle{background:#ffd1d1; border-color:#ff8f8f;}
    .player{outline:3px solid #2d3436; outline-offset:-3px;}

    /* ===== Dパッド（長押し対応） ===== */
    #pad{
      position:absolute; right:12px; bottom:22px; z-index:30;
      display:grid; grid-template-columns:64px 64px 64px; grid-template-rows:64px 64px 64px; gap:8px;
      touch-action:none; user-select:none;
    }
    .pad-btn{
      background:linear-gradient(45deg,#74b9ff,#0984e3); color:#fff; border:none;
      width:64px; height:64px; border-radius:14px; font-size:28px; font-weight:900;
      box-shadow:0 6px 16px rgba(0,0,0,.3);
      touch-action:none;
    }
    .pad-btn:active{transform:scale(.94);}
    #pad .center{background:linear-gradient(45deg,#fdcb6e,#e17055);}

    /* ===== 戦闘/町/ボス/汎用画面 ===== */
    .panel{
      width:min(92vw,840px);
      background:var(--panel); border:3px solid #ececec; border-radius:16px;
      box-shadow:0 10px 26px rgba(0,0,0,.15); padding:18px; margin:10px auto;
    }
    .cmds{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;}
    .cmds .btn{width:calc(50% - 8px); max-width:260px;}

    /* アクセシビリティ */
    button{min-height:48px; -webkit-tap-highlight-color: transparent;}
  </style>
</head>
<body>
  <div id="game">
    <!-- ======= 各画面 ======= -->
    <div id="title" class="screen">
      <h1>🏰 勇者の冒険 ⚔️</h1>
      <p>タップで進みます。</p>
      <button class="btn" id="start">▶️ はじめる</button>
    </div>

    <div id="opening" class="screen hidden">
      <div class="panel">
        <h2>✨ オープニング ✨</h2>
        <p>せかいは まおうに おびやかされている。<br>ゆうしゃよ、たちあがれ。</p>
      </div>
      <button class="btn" id="toDeparture">勇者の出発へ ➡️</button>
    </div>

    <div id="departure" class="screen hidden">
      <div class="panel">
        <h2>🏘️ 村</h2>
        <p>ゆうしゃは どうぐを ととのえ たびに でる。</p>
      </div>
      <button class="btn" id="toField">フィールドへ ➡️</button>
    </div>

    <!-- ===== フィールド（HUD + ビューウィンドウ + Dパッド + メッセージ） ===== -->
    <div id="fieldScreen" class="screen hidden" style="background:linear-gradient(135deg,#55efc4,#81ecec)">
      <div id="hud">
        <div class="hud-group">
          <span class="tag">ゆうしゃ Lv.<b id="lv">1</b></span>
          <div class="tag">💰 <span id="gold">100</span>G</div>
        </div>
        <div class="hud-group">
          <div class="tag">❤️ <b id="hp">100</b>/<b id="maxhp">100</b></div>
          <div class="bar"><i id="hpbar" style="width:100%"></i></div>
          <div class="tag">💫 <b id="mp">30</b>/<b id="maxmp">30</b></div>
          <div class="bar mp"><i id="mpbar" style="width:100%"></i></div>
        </div>
      </div>

      <div id="field">
        <div id="grid" aria-label="フィールドマップ"></div>
      </div>

      <div id="msg">フリックか矢印（長押し可）で いどうします。</div>

      <!-- Dパッド -->
      <div id="pad">
        <div></div><button class="pad-btn" data-dir="up">⬆️</button><div></div>
        <button class="pad-btn" data-dir="left">⬅️</button>
        <button class="pad-btn center" id="act">⚡</button>
        <button class="pad-btn" data-dir="right">➡️</button>
        <div></div><button class="pad-btn" data-dir="down">⬇️</button><div></div>
      </div>
    </div>

    <!-- 戦闘 -->
    <div id="battle" class="screen hidden" style="background:linear-gradient(135deg,#ff7675,#d63031); color:#fff">
      <div class="panel" style="background:rgba(255,255,255,.95);color:#2d3436">
        <h2>⚔️ たたかい</h2>
        <p id="battleMsg">スライムが あらわれた！</p>
        <div class="cmds">
          <button class="btn" id="atk">⚔️ たたかう</button>
          <button class="btn outline" id="run">💨 にげる</button>
        </div>
      </div>
    </div>

    <!-- 町/城 -->
    <div id="town" class="screen hidden">
      <div class="panel">
        <h2 id="townTitle">🏘️ まち</h2>
        <p id="townMsg">やすんで たいりょくが かいふくした。</p>
        <div class="cmds">
          <button class="btn" id="rest">💤 やすむ</button>
          <button class="btn outline" id="backToField1">⬅️ フィールドへ</button>
        </div>
      </div>
    </div>

    <!-- ラスボス -->
    <div id="boss" class="screen hidden" style="background:linear-gradient(45deg,#ff9a9e,#fad0c4)">
      <div class="panel">
        <h2>🔥 まおう</h2>
        <p id="bossMsg">まおうが あらわれた！</p>
        <div class="cmds">
          <button class="btn" id="bossAtk">⚔️ たたかう</button>
          <button class="btn outline" id="bossRun">💨 にげる</button>
        </div>
      </div>
    </div>

    <!-- エンディング -->
    <div id="ending" class="screen hidden" style="background:linear-gradient(45deg,#00cec9,#0984e3); color:#fff">
      <div class="panel" style="background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.4); color:#fff">
        <h2>🎉 エンディング 🎉</h2>
        <p>まおうは たおれた。せかいに へいわが もどった。</p>
        <p>そして ゆうしゃの ぼうけんは でんせつと なった。</p>
      </div>
    </div>
  </div>

  <script>
    // ===== データ =====
    const player = {
      x: 2, y: 10, hp: 100, maxHp: 100, mp: 30, maxMp: 30, lv: 1, gold: 100
    };

    // 基本マップ（8x12）
    const baseMap = [
      "PPPPPPPPBPPP",
      "PPFFPPPMMPPP",
      "PPFFPPPMMPPP",
      "PPPPTPPPPPPP",
      "PPPPPPCPPPPP",
      "PPPPPPPPPPPP",
      "PPDPPWPPPPPP",
      "PPDPPWPPPPPP"
    ];

    // 4倍面積 = 縦横2倍に拡大（16x24）
    function scaleMap(src, sx=2, sy=2){
      const rows = [];
      for(const row of src){
        let scaledRow = "";
        for(const ch of row){ scaledRow += ch.repeat(sx); }
        for(let i=0;i<sy;i++) rows.push(scaledRow);
      }
      return rows;
    }
    const map = scaleMap(baseMap, 2, 2);
    const rows = map.length;
    const cols = map[0].length;

    // ビュー（表示する範囲を固定して見やすく）
    const VIEW_COLS = Math.min(12, cols);
    const VIEW_ROWS = Math.min(8, rows);

    const tileEmoji = {
      "P":"", "F":"🌲", "M":"⛰️", "D":"🏜️", "W":"🌊",
      "T":"🏘️", "C":"🕳️", "B":"🏰"
    };

    // ===== 画面制御 =====
    const screens = ["title","opening","departure","fieldScreen","battle","town","boss","ending"];
    const show = id => {
      screens.forEach(s=>document.getElementById(s).classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    };

    // ===== UI初期化 =====
    const gridEl = document.getElementById("grid");
    function renderField(){
      // ビュー中心をプレイヤーに寄せる
      const startX = clamp(player.x - Math.floor(VIEW_COLS/2), 0, Math.max(0, cols - VIEW_COLS));
      const startY = clamp(player.y - Math.floor(VIEW_ROWS/2), 0, Math.max(0, rows - VIEW_ROWS));
      gridEl.style.setProperty("--cols", VIEW_COLS);
      gridEl.innerHTML = "";
      for(let y=0;y<VIEW_ROWS;y++){
        for(let x=0;x<VIEW_COLS;x++){
          const mx = startX + x, my = startY + y;
          const code = map[my][mx];
          const tile = document.createElement("div");
          tile.className = "tile " + tileClass(code);
          if (mx===player.x && my===player.y) tile.classList.add("player");
          tile.textContent = (mx===player.x && my===player.y) ? "🧙‍♂️" : (tileEmoji[code]||"");
          gridEl.appendChild(tile);
        }
      }
      updateHud();
    }
    function tileClass(code){
      return {
        "P":"plains", "F":"forest", "M":"mountain", "D":"desert", "W":"water",
        "T":"town", "C":"cave", "B":"castle"
      }[code] || "plains";
    }

    function updateHud(){
      const pctHp = Math.max(0, Math.min(100, Math.round(player.hp/player.maxHp*100)));
      const pctMp = Math.max(0, Math.min(100, Math.round(player.mp/player.maxMp*100)));
      document.getElementById("hp").textContent = player.hp;
      document.getElementById("maxhp").textContent = player.maxHp;
      document.getElementById("mp").textContent = player.mp;
      document.getElementById("maxmp").textContent = player.maxMp;
      document.getElementById("lv").textContent = player.lv;
      document.getElementById("gold").textContent = player.gold;
      document.getElementById("hpbar").style.width = pctHp + "%";
      document.getElementById("mpbar").style.width = pctMp + "%";
    }

    // ===== 入出力 =====
    const msg = (t)=> document.getElementById("msg").textContent = t;
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // 方向移動
    function move(dx,dy){
      const nx = clamp(player.x+dx, 0, cols-1);
      const ny = clamp(player.y+dy, 0, rows-1);
      // 水は進入不可
      if (map[ny][nx] === "W") { vibrate([50]); msg("みずで すすむことが できない"); return; }
      player.x = nx; player.y = ny;
      renderField();
      handleStep();
    }

    // 一歩ごとのイベント
    function handleStep(){
      const code = map[player.y][player.x];
      if(code==="T"){
        document.getElementById("townTitle").textContent = "🏘️ まち";
        document.getElementById("townMsg").textContent = "やすんで HP/MP が かいふくした。";
        show("town");
        return;
      }
      if(code==="C"){
        if (rand() < 0.5){ startBattle("どうくつで モンスターが あらわれた！"); return; }
        msg("くらい どうくつだ…");
        return;
      }
      if(code==="B"){
        show("boss");
        return;
      }
      const rate = {"F":0.22,"M":0.26,"D":0.18,"P":0.10}[code] || 0.12;
      if (rand() < rate){ startBattle(encounterText(code)); }
      else { msg(terrainText(code)); }
    }

    function terrainText(code){
      return {
        "F":"もりに はいった。モンスターが でそうだ…",
        "M":"けわしい やまだ。きを つけて。",
        "D":"あつい さばく。のどが かわく…",
        "P":"ひらけた へいや。",
        "T":"まち",
        "C":"どうくつ",
        "B":"まおうのしろ"
      }[code] || "";
    }
    function encounterText(code){
      return {
        "F":"もりから モンスターが あらわれた！",
        "M":"やまかげから モンスターが あらわれた！",
        "D":"さばくの すなから モンスターが あらわれた！",
        "P":"モンスターが あらわれた！"
      }[code] || "モンスターが あらわれた！";
    }

    function rand(){ return Math.random(); }
    function vibrate(p){ if (navigator.vibrate) navigator.vibrate(p); }

    // ===== 戦闘処理（簡易） =====
    function startBattle(text){
      document.getElementById("battleMsg").textContent = text;
      show("battle");
    }
    document.getElementById("atk").addEventListener("click", ()=>{
      const g = 10 + Math.floor(Math.random()*20);
      player.gold += g;
      player.hp = Math.min(player.maxHp, player.hp + 5);
      msg("てきを たおした！ +" + g + "G"); show("fieldScreen");
      updateHud(); renderField();
    }, {passive:true});
    document.getElementById("run").addEventListener("click", ()=>{
      msg("にげだした！"); show("fieldScreen");
    }, {passive:true});

    // ===== 町/休憩 =====
    document.getElementById("rest").addEventListener("click", ()=>{
      player.hp = player.maxHp; player.mp = player.maxMp; vibrate([120]);
      document.getElementById("townMsg").textContent = "HP/MP が ぜんかいふく！";
      updateHud();
    }, {passive:true});
    document.getElementById("backToField1").addEventListener("click", ()=>{
      show("fieldScreen"); msg("どこへ むかう？"); renderField();
    }, {passive:true});

    // ===== ラスボス =====
    document.getElementById("bossAtk").addEventListener("click", ()=>{
      show("ending");
    }, {passive:true});
    document.getElementById("bossRun").addEventListener("click", ()=>{
      document.getElementById("bossMsg").textContent = "にげられない！";
      vibrate([80,40,80]);
    }, {passive:true});

    // ===== Dパッド（長押しで連続移動）/スワイプ/キー =====
    const repeat = { timer:null, delay:null };
    function startRepeat(dx,dy){
      stopRepeat();
      move(dx,dy); // すぐ1歩
      repeat.delay = setTimeout(()=>{
        repeat.timer = setInterval(()=> move(dx,dy), 110); // 連続移動
      }, 230); // 長押し判定
    }
    function stopRepeat(){
      clearTimeout(repeat.delay); repeat.delay=null;
      clearInterval(repeat.timer); repeat.timer=null;
    }

    document.querySelectorAll("#pad .pad-btn[data-dir]").forEach(b=>{
      const dir = b.dataset.dir;
      const dxy = dir==="up"   ? [0,-1] :
                  dir==="down" ? [0, 1] :
                  dir==="left" ? [-1,0] : [1,0];
      // pointer イベントで統一（iOS対応）
      b.addEventListener("pointerdown", (e)=>{ e.preventDefault(); startRepeat(...dxy); });
      b.addEventListener("pointerup",   (e)=>{ e.preventDefault(); stopRepeat(); });
      b.addEventListener("pointercancel",(e)=>{ e.preventDefault(); stopRepeat(); });
      b.addEventListener("pointerleave",(e)=>{ e.preventDefault(); stopRepeat(); });
    });
    document.getElementById("act").addEventListener("click", ()=>{
      const code = map[player.y][player.x];
      if(code==="T"){ show("town"); }
      else if(code==="B"){ show("boss"); }
      else if(code==="C"){ startBattle("どうくつの おくから おとが する… モンスターだ！"); }
      else { msg("となりの マスへ いどうしてください。"); }
    }, {passive:true});

    // スワイプ移動（1歩）
    let tsX=0, tsY=0;
    const fieldScreen = document.getElementById("fieldScreen");
    fieldScreen.addEventListener("touchstart", e=>{
      const t=e.touches[0]; tsX=t.clientX; tsY=t.clientY;
    }, {passive:true});
    fieldScreen.addEventListener("touchend", e=>{
      const dx = e.changedTouches[0].clientX - tsX;
      const dy = e.changedTouches[0].clientY - tsY;
      const ax = Math.abs(dx), ay = Math.abs(dy);
      if(Math.max(ax,ay) < 20) return;
      if(ax>ay){ move(dx>0?1:-1,0); } else { move(0, dy>0?1:-1); }
    }, {passive:true});

    // キーボード（開発時）
    window.addEventListener("keydown", e=>{
      if(document.getElementById("fieldScreen").classList.contains("hidden")) return;
      if(e.key==="ArrowUp") move(0,-1);
      if(e.key==="ArrowDown") move(0,1);
      if(e.key==="ArrowLeft") move(-1,0);
      if(e.key==="ArrowRight") move(1,0);
    });

    // ===== 画面遷移ボタン =====
    document.getElementById("start").addEventListener("click", ()=>show("opening"), {passive:true});
    document.getElementById("toDeparture").addEventListener("click", ()=>show("departure"), {passive:true});
    document.getElementById("toField").addEventListener("click", ()=>{ show("fieldScreen"); renderField(); msg("フィールドへ でた"); }, {passive:true});

    // 初期表示
    show("title");
  </script>
</body>
</html>
